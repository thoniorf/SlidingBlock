#maxint=20.
% matrix
row(0..2). col(0..2). cella(X,Y):-col(X),row(Y).
% input facts
% blocks
blocco(1,1,1).blocco(2,1,1).blocco(3,1,1).blocco(4,1,1). blocco(6,2,1).
% key block
key(6).
% exit cell
exit(0,2).
% contiene (colonna,riga,blocco,turno).
contiene(0,0,1,0).contiene(0,1,2,0).contiene(1,1,3,0).contiene(1,2,4,0).contiene(1,0,6,0). contiene(2,0,6,0).
% turno
turno(T):-#int(T),T>0.
% adiacenza celle
% adiacente(c1.colonna,c1.riga,c2.colonna,c2.riga)
adiacente(X,Y,X,Y1) :- cella(X,Y),cella(X,Y1),Y1=Y+1.
adiacente(X,Y,X1,Y) :- cella(X,Y),cella(X1,Y),X1=X+1.
adiacente(X,Y,X1,Y1) :- adiacente(X1,Y1,X,Y).
% celle occupate
occupata(X,Y,T) :- contiene(X,Y,_,T).
% Vittoria
vittoria :- contiene(X,Y,B,T),key(B),exit(X,Y).
%% GUESS %%
sposta(B,T) | nonsposta(B,T) :-blocco(B,_,_),turno(T),not vittoria.
%% SUPPORT RULES %%
% Aggiornamento pezzi non spostati
contiene(X,Y,B,T) :- nonsposta(B,T), contiene(X,Y,B,T0),T0=T-1.
% Spostamento del blocco nella nuova cella
contiene(X,Y,B,T):- sposta(B,T),contiene(X0,Y0,B,T0),not occupata(X,Y,T0),adiacente(X,Y,X0,Y0),T0=T-1.
%% CONSTRAINTS %%
% Non è possibile che ci siano diversi blocchi nella stessa cella
:-contiene(X,Y,B,T),contiene(X,Y,B1,T),B1!=B.
% Non è possibile che che due id dello stesso blocco non siano adiacenti
:-contiene(X,Y,B,T),contiene(X,Y1,B,T),not adiacente(X,Y,X,Y1),Y>Y1.
:-contiene(X,Y,B,T),contiene(X1,Y,B,T),not adiacente(X,Y,X1,Y),X>X1.
% Non è possibile che nello stesso turno si sposti più di un blocco
:-sposta(B,T),sposta(B1,T),B1!=B.
% Non è possibile spostare un pezzo nella posizione precedente
:-sposta(T,B),sposta(T1,B),sposta(T2,B),T2>T1,T1>T,contiene(X,Y,B,T),contiene(X,Y,B,T2),not adiacente(X,Y,Xb,Yb),contiene(Xb,Yb,B,T).
% Non è possibile che in un turno non si sia spostato niente
:-turno(T),not vittoria,#count{B:sposta(B,T)}=0.
% Non è possibile che il numero di celle che contengono il blocco eccedono la sua dimensione
:-blocco(B,Width,Height),contiene(_,_,B,T), not #count{Xw,Yw:contiene(Xw,Yw,B,T)}=Width, not #count{Yh,Xh:contiene(Xh,Yh,B,T)}=Height.
:-not vittoria.

%% TEST with FATCS %%

%% RULES FOR DEBUG %%
